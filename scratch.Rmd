---
title: "R Notebook"
output: html_notebook
---

```{r}
# Install scripts and source packages
# install.packages("devtools")
# library(devtools)
# devtools::install_github("kingaa/pomp")
# devtools::install_github("krlmlr/here")
# install.packages("tidyverse")
library(pomp2)
library(here)
library(dplyr)
library(ggplot2)
```

```{r}
# Load data
# TODO: do we check the data sources? Where are they coming from?
dzzDataFile <- here::here("cities", "Brazil", "all data.csv")
brazil_measles <- data.frame(read.csv(dzzDataFile,header=TRUE)) %>%
  filter(dzz == "measles" & gender == "both" & year %in% 1979:1995) %>%
  mutate(measles0_9 = under1 + one_4 + five_9)
brazil_population = data.frame(read.csv(
  here::here("cities","Brazil populations.csv"),header=TRUE)) %>%
  filter(location == "Brazil" & gender == "both" & year %in% 1979:1995) %>%
  mutate(pop0_9 = X0_4 + X5_9) # TODO: check if this sum is right
# given that 0_1 + 1_4 does not equal 0_4
```

```{r}
# Define POMP model. Reusing the model in
# https://kingaa.github.io/short-course/measles/measles.html#the-partially-observed-markov-process-model,
# which is from He, Ionides, & King, J. R. Soc. Interface (2010).
birthrate = 50000
pop = 3390000
# see https://en.wikipedia.org/wiki/Compartmental_models_in_epidemiology to
# understand the SIR model setup, the definitions of concepts like transmission/
# contact rate and force of infection and the conventional variable names (e.g.
# beta, gamma)
rproc <- Csnippet(stringr::str_interp("
  double beta, br, seas, foi, dw, births;
  double rate[8], trans[8];
  double birthrate = $[d]{birthrate};
  double pop = $[d]{pop};

  // cohort effect
  if (fabs(t-floor(t)-251.0/365.0) < 0.5*dt)
    br = cohort*birthrate/dt + (1-cohort)*birthrate;
  else
    br = (1.0-cohort)*birthrate;

  // term-time seasonality
  t = (t-floor(t))*365.25;
  if ((t>=7&&t<=100) || (t>=115&&t<=199) || (t>=252&&t<=300) || (t>=308&&t<=356))
      seas = 1.0+amplitude*0.2411/0.7589;
    else
      seas = 1.0-amplitude;

  // transmission rate
  beta = R0*(gamma+mu)*seas;
  // expected force of infection
  foi = beta*pow(I+iota,alpha)/pop;
  // white noise (extrademographic stochasticity)
  dw = rgammawn(sigmaSE,dt);

  rate[0] = foi*dw/dt;  // stochastic force of infection
  rate[1] = mu;             // natural S death
  rate[2] = sigma;        // rate of ending of latent stage
  rate[3] = mu;             // natural E death
  rate[4] = gamma;        // rate of entering immune amnesia
  rate[5] = mu;             // natural I death
  rate[6] = phi;             // recovery
  rate[7] = mu;             // natural A death

  // Poisson births
  births = rpois(br*dt);

  // transitions between classes
  reulermultinom(2,S,&rate[0],dt,&trans[0]);
  reulermultinom(2,E,&rate[2],dt,&trans[2]);
  reulermultinom(2,I,&rate[4],dt,&trans[4]);
  reulermultinom(2,A,&rate[6],dt,&trans[6]);

  S += births   - trans[0] - trans[1];
  E += trans[0] - trans[2] - trans[3];
  I += trans[2] - trans[4] - trans[5];
  A += trans[4] - trans[6] - trans[7];
  R = pop - S - E - I - A;
  W += (dw - dt)/sigmaSE;  // standardized i.i.d. white noise
  C += trans[4];           // true incidence
"))
initlz <- Csnippet(stringr::str_interp("
  double pop = $[d]{pop};
  double m = pop/(S_0+E_0+I_0+A_0+R_0);
  S = nearbyint(m*S_0);
  E = nearbyint(m*E_0);
  I = nearbyint(m*I_0);
  A = nearbyint(m*A_0);
  R = nearbyint(m*R_0);
  W = 0;
  C = 0;
"))
dmeas <- Csnippet("
  double m = rho*C;
  double v = m*(1.0-rho+psi*psi*m);
  double tol = 1.0e-18;
  if (cases > 0.0) {
    lik = pnorm(cases+0.5,m,sqrt(v)+tol,1,0)-pnorm(cases-0.5,m,sqrt(v)+tol,1,0)+tol;
  } else {
    lik = pnorm(cases+0.5,m,sqrt(v)+tol,1,0)+tol;
  }
")
rmeas <- Csnippet("
  double m = rho*C;
  double v = m*(1.0-rho+psi*psi*m);
  double tol = 1.0e-18;
  cases = rnorm(m,sqrt(v)+tol);
  if (cases > 0.0) {
    cases = nearbyint(cases);
  } else {
    cases = 0.0;
  }
")
times <- seq(from=1979, to=1995, by=1/52)
paramnames <- c("R0","mu","sigma","gamma","phi","alpha","iota",
                         "rho","sigmaSE","psi","cohort","amplitude",
                         "S_0","E_0","I_0","A_0","R_0")
sir <- pomp(data = NULL, times = times, t0 = 2*times[1]-times[2],
            rprocess=euler(rproc,delta.t=1/365.25),
            rinit=initlz,
            dmeasure=dmeas,
            rmeasure=rmeas,
            obsnames = "cases",
            accumvars=c("C","W"),
            statenames=c("S","E","I","A","R","C","W"),
            paramnames=paramnames)
# I estimate phi as 1 / (duration of proposed amnesia) = 1/(2 years) = 1/2. Mina
# et al. Science 2016 (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4823017/)
# and https://www.nature.com/articles/s41467-018-07515-0 observe amnesia for at
# least 2 years, which means we need the A compartment to last on average at
# least 2 years; then, if we're modeling a country with low background of
# infectious disease, we'll observe mortality due to amnesia spread out over the
# 2 years; if we're modeling a country with high background of infectious
# disease, we'll observe mortality due to amnesia more quickly than 2 years.
# Then 2 years is a necessary lower bound on average duration in A. Relevant
# quote from the Nature article: "The disease [measles] is associated with a
# transient immune suppression and increased risk of childhood morbidity and
# mortality for a period of more than 2 years."
read.csv(text="
town,loglik,loglik.sd,mu,delay,sigma,gamma,phi,rho,R0,amplitude,alpha,iota,cohort,psi,S_0,E_0,I_0,A_0,R_0,sigmaSE
London,-3804.9,0.16,0.02,4,28.9,30.4,0.5,0.488,56.8,0.554,0.976,2.9,0.557,0.116,0.0297,5.17e-05,5.14e-05,5e-05,0.97,0.0878
",stringsAsFactors=FALSE) -> mle
mle %>% select(paramnames) %>% unlist() -> theta
```

```{r}
# Run and plot simulation
# Estimate gamma based on infectious period of measles estimated at 6-7 days:
# "Measles virus is shed from the nasopharynx beginning with the prodrome until
# 3–4 days after rash onset. The incubation period of measles, from exposure to
# prodrome, averages 10–12 days. From exposure to rash onset averages 14 days
# (range, 7–21 days)." Then 1/gamma is about 1/52 of a year, or gamma=52.
# beta = gamma * R_0 = 52 * 15 = 780.
# https://www.cdc.gov/vaccines/pubs/pinkbook/downloads/meas.pdf
sir %>%
  # simulate(params=c(Beta=1.5,gamma=1,rho=0.9,N=2600),
  simulate(params=theta,
           # can make N adj w/ time
           # change nsim back to 20
           nsim=10,format="data.frame", seed = 96) -> sims
sims %>%
  ggplot(aes(x=time,y=cases,group=.id,color=.id=="data"))+
  geom_line()+
  guides(color=FALSE)+
  facet_wrap(~.id,ncol=2)
```